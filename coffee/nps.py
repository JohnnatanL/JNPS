import streamlit as st
import re
from bd import insert_data

#st.set_page_config(page_title="Pesquisa NPS", layout="wide")

# Inicializa√ß√£o do session_state
if 'responses' not in st.session_state:
    st.session_state.responses = []
if 'selected_score' not in st.session_state:
    st.session_state.selected_score = None

# Fun√ß√£o para criar estilo do bot√£o
def get_button_style(score):
    if st.session_state.selected_score == score:
        return {"backgroundColor": "#0066cc", "color": "white"}
    return {}

# Fun√ß√£o para atualizar a nota selecionada
def update_score(score):
    st.session_state.selected_score = score
    st.session_state.nota = str(score)

# Inicializa√ß√£o da nota no session_state
if 'nota' not in st.session_state:
    st.session_state.nota = ""

st.header("üåü Pesquisa NPS")

col_nome, col_email = st.columns(2)
with col_nome:
    nome = st.text_input("Seu Nome")
def validate_phone(phone):
    # Remove todos os caracteres n√£o num√©ricos
    numbers_only = re.sub(r'[^0-9]', '', phone)
    
    # Verifica se o n√∫mero est√° vazio
    if not numbers_only:
        return False, "Por favor, digite um n√∫mero de telefone"
    
    # Verifica se o n√∫mero tem entre 10 e 11 d√≠gitos (com DDD)
    if len(numbers_only) < 10 or len(numbers_only) > 11:
        return False, "N√∫mero inv√°lido. Digite um n√∫mero com DDD (ex: 11999999999)"
    
    # Verifica se come√ßa com DDD v√°lido (assumindo DDDs do Brasil)
    ddd = numbers_only[:2]
    if not (10 <= int(ddd) <= 99):
        return False, "DDD inv√°lido"
    
    # Se tiver 11 d√≠gitos, verifica se o primeiro d√≠gito ap√≥s DDD √© 9
    if len(numbers_only) == 11 and numbers_only[2] != '9':
        return False, "Celular deve come√ßar com 9"
    
    return True, "N√∫mero v√°lido!"

def format_phone(phone):
    # Remove todos os caracteres n√£o num√©ricos
    numbers_only = re.sub(r'[^0-9]', '', phone)
    
    if len(numbers_only) == 11:
        return f"({numbers_only[:2]}) {numbers_only[2:7]}-{numbers_only[7:]}"
    elif len(numbers_only) == 10:
        return f"({numbers_only[:2]}) {numbers_only[2:6]}-{numbers_only[6:]}"
    return phone

# Inicializa o estado para o n√∫mero de telefone se n√£o existir
if 'phone_number' not in st.session_state:
    st.session_state.phone_number = ""
if 'phone_valid' not in st.session_state:
    st.session_state.phone_valid = False
if 'validation_message' not in st.session_state:
    st.session_state.validation_message = ""

def on_phone_change():
    # Valida e formata o n√∫mero quando o input muda
    is_valid, message = validate_phone(st.session_state.phone_input)
    st.session_state.phone_valid = is_valid
    st.session_state.validation_message = message
    if is_valid:
        st.session_state.phone_number = format_phone(st.session_state.phone_input)
    else:
        st.session_state.phone_number = st.session_state.phone_input

# Cria o input com valida√ß√£o
with col_email:
    phone_input = st.text_input(
        "WhatsApp",
        key="phone_input",
        value=st.session_state.phone_number,
        on_change=on_phone_change,
        placeholder="(11) 99999-9999"
    )

# Mostra mensagem de valida√ß√£o com cores diferentes
if st.session_state.validation_message:
    if st.session_state.phone_valid:
        st.success(st.session_state.validation_message)
    else:
        st.error(st.session_state.validation_message)

# Se quiser acessar o n√∫mero v√°lido em outro lugar do c√≥digo:
if st.session_state.phone_valid:
    number_only = re.sub(r'[^0-9]', '', st.session_state.phone_number)

st.write("Como voc√™ avalia nossa empresa?")

cola, colb = st.columns(2)
with cola:
    col0, col1, col2, col3, col4, col5, col6, col7, col8, col9, col10 = st.columns(11)

# Defini√ß√£o dos bot√µes com emojis e estilos
buttons_config = [
    (col0, "üò¢ 0", 0),
    (col1, "üò¢ 1", 1),
    (col2, "üò¢ 2", 2),
    (col3, "üòï 3", 3),
    (col4, "üòï 4", 4),
    (col5, "üòï 5", 5),
    (col6, "üòê 6", 6),
    (col7, "üòê 7", 7),
    (col8, "üôÇ 8", 8),
    (col9, "üôÇ 9", 9),
    (col10, "üòÑ 10", 10)
]

# Cria√ß√£o dos bot√µes com estados persistentes
for col, label, score in buttons_config:
    with col:
        if st.button(
            label,
            key=f"btn_{score}",
            use_container_width=True,
            type="primary" if st.session_state.selected_score == score else "secondary",
            on_click=update_score,
            args=(score,)
        ):
            pass

with colb:
    colba, colbb, colbc, colbd, colbe = st.columns(5)

produtos = st.multiselect("Qual caf√© de sua prefer√™ncia?", options=["Cerrado", "100% Ar√°bica", "Mogiana", "Expresso", "Tradicional", "Extraforte"])

comentario = st.text_area("Deixe seu coment√°rio (opcional)")

enviar = st.button("Enviar Resposta")

if enviar and nome and phone_input and st.session_state.validation_message == "N√∫mero v√°lido!" and score:
    insert_data(nome, number_only, score, produtos, comentario)